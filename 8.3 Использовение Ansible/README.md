# Домашнее задание к занятию 3 «Использование Ansible»

## Основная часть

#### 1. Допишите playbook: нужно сделать ещё один play, который устанавливает и настраивает LightHouse.

#### 2. При создании tasks рекомендую использовать модули: `get_url`, `template`, `yum`, `apt`.

#### 3. Tasks должны: скачать статику LightHouse, установить Nginx или любой другой веб-сервер, настроить его конфиг для открытия LightHouse, запустить веб-сервер.

#### 4. Подготовьте свой inventory-файл `prod.yml`.

#### 5. Запустите `ansible-lint site.yml` и исправьте ошибки, если они есть.

```bash
➜  playbook git:(main) ✗ ansible-lint site.yml                          

Passed: 0 failure(s), 0 warning(s) on 1 files. Last profile that met the validation criteria was 'production'.
```

#### 6. Попробуйте запустить playbook на этом окружении с флагом `--check`.

```bash
➜  playbook git:(main) ✗ ansible-playbook -i inventory/prod.yml site.yml --check

PLAY [CA certificates] ********************************************************************************************************************************

TASK [Gathering Facts] ********************************************************************************************************************************
ok: [hw_8_2_clickhouse]
ok: [hw_8_2_lighthouse]
ok: [hw_8_2_vector]

TASK [Install CA] *************************************************************************************************************************************
ok: [hw_8_2_lighthouse]
ok: [hw_8_2_vector]
fatal: [hw_8_2_clickhouse]: FAILED! => {"changed": false, "msg": "No package matching 'ca-certificates=20230311ubuntu0.22*' found available, installed or updated", "rc": 126, "results": ["No package matching 'ca-certificates=20230311ubuntu0.22*' found available, installed or updated"]}

PLAY [Install Clickhouse] *****************************************************************************************************************************

PLAY [Installing Vector] ******************************************************************************************************************************

TASK [Gathering Facts] ********************************************************************************************************************************
ok: [hw_8_2_vector]

TASK [Get vector distrib] *****************************************************************************************************************************
ok: [hw_8_2_vector]

TASK [Install package vector] *************************************************************************************************************************
ok: [hw_8_2_vector]

TASK [Enable vector] **********************************************************************************************************************************
ok: [hw_8_2_vector]

TASK [Start vector service] ***************************************************************************************************************************
changed: [hw_8_2_vector]

PLAY [NGINX] ******************************************************************************************************************************************

TASK [Gathering Facts] ********************************************************************************************************************************
ok: [hw_8_2_lighthouse]

TASK [Installing nginx] *******************************************************************************************************************************
ok: [hw_8_2_lighthouse]

TASK [Copying lighthouse repo] ************************************************************************************************************************
ok: [hw_8_2_lighthouse]

TASK [Adding available site] **************************************************************************************************************************
ok: [hw_8_2_lighthouse]

TASK [Create simlink lighthouse enable] ***************************************************************************************************************
ok: [hw_8_2_lighthouse]

PLAY RECAP ********************************************************************************************************************************************
hw_8_2_clickhouse          : ok=1    changed=0    unreachable=0    failed=1    skipped=0    rescued=0    ignored=0   
hw_8_2_lighthouse          : ok=7    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   
hw_8_2_vector              : ok=7    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0 
```

#### 7. Запустите playbook на `prod.yml` окружении с флагом `--diff`. Убедитесь, что изменения на системе произведены.

```bash
➜  playbook git:(main) ✗ ansible-playbook -i inventory/prod.yml site.yml --diff

PLAY [CA certificates] ********************************************************************************************************************************

TASK [Gathering Facts] ********************************************************************************************************************************
ok: [hw_8_2_vector]
ok: [hw_8_2_lighthouse]
ok: [hw_8_2_clickhouse]

TASK [Install CA] *************************************************************************************************************************************
ok: [hw_8_2_lighthouse]
ok: [hw_8_2_vector]
fatal: [hw_8_2_clickhouse]: FAILED! => {"changed": false, "msg": "No package matching 'ca-certificates=20230311ubuntu0.22*' found available, installed or updated", "rc": 126, "results": ["No package matching 'ca-certificates=20230311ubuntu0.22*' found available, installed or updated"]}

PLAY [Install Clickhouse] *****************************************************************************************************************************

PLAY [Installing Vector] ******************************************************************************************************************************

TASK [Gathering Facts] ********************************************************************************************************************************
ok: [hw_8_2_vector]

TASK [Get vector distrib] *****************************************************************************************************************************
ok: [hw_8_2_vector]

TASK [Install package vector] *************************************************************************************************************************
ok: [hw_8_2_vector]

TASK [Enable vector] **********************************************************************************************************************************
ok: [hw_8_2_vector]

TASK [Start vector service] ***************************************************************************************************************************
changed: [hw_8_2_vector]

PLAY [NGINX] ******************************************************************************************************************************************

TASK [Gathering Facts] ********************************************************************************************************************************
ok: [hw_8_2_lighthouse]

TASK [Installing nginx] *******************************************************************************************************************************
ok: [hw_8_2_lighthouse]

TASK [Copying lighthouse repo] ************************************************************************************************************************
ok: [hw_8_2_lighthouse]

TASK [Adding available site] **************************************************************************************************************************
--- before
+++ after: /Users/shlagin/.ansible/tmp/ansible-local-95284kd0yk9yj/tmpm5db2egk/lighthouse.j2
@@ -0,0 +1,10 @@
+server {
+    listen    80;
+       server_name localhost;
+       location / {
+
+           root /opt/lighthouse;
+               index index.html;
+
+       }
+}
\ No newline at end of file

changed: [hw_8_2_lighthouse]

TASK [Create simlink lighthouse enable] ***************************************************************************************************************
--- before
+++ after
@@ -1,4 +1,4 @@
 {
     "path": "/etc/nginx/sites-enabled/lighthouse",
-    "state": "absent"
+    "state": "link"
 }

changed: [hw_8_2_lighthouse]

RUNNING HANDLER [Start nginx service] *****************************************************************************************************************
changed: [hw_8_2_lighthouse]

PLAY RECAP ********************************************************************************************************************************************
hw_8_2_clickhouse          : ok=1    changed=0    unreachable=0    failed=1    skipped=0    rescued=0    ignored=0   
hw_8_2_lighthouse          : ok=8    changed=3    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   
hw_8_2_vector              : ok=7    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   
```

#### 8. Повторно запустите playbook с флагом `--diff` и убедитесь, что playbook идемпотентен.

```bash
➜  playbook git:(main) ✗ ansible-playbook -i inventory/prod.yml site.yml --diff

PLAY [CA certificates] ********************************************************************************************************************************

TASK [Gathering Facts] ********************************************************************************************************************************
ok: [hw_8_2_clickhouse]
ok: [hw_8_2_vector]
ok: [hw_8_2_lighthouse]

TASK [Install CA] *************************************************************************************************************************************
ok: [hw_8_2_lighthouse]
ok: [hw_8_2_vector]
fatal: [hw_8_2_clickhouse]: FAILED! => {"changed": false, "msg": "No package matching 'ca-certificates=20230311ubuntu0.22*' found available, installed or updated", "rc": 126, "results": ["No package matching 'ca-certificates=20230311ubuntu0.22*' found available, installed or updated"]}

PLAY [Install Clickhouse] *****************************************************************************************************************************

PLAY [Installing Vector] ******************************************************************************************************************************

TASK [Gathering Facts] ********************************************************************************************************************************
ok: [hw_8_2_vector]

TASK [Get vector distrib] *****************************************************************************************************************************
ok: [hw_8_2_vector]

TASK [Install package vector] *************************************************************************************************************************
ok: [hw_8_2_vector]

TASK [Enable vector] **********************************************************************************************************************************
ok: [hw_8_2_vector]

TASK [Start vector service] ***************************************************************************************************************************
changed: [hw_8_2_vector]

PLAY [NGINX] ******************************************************************************************************************************************

TASK [Gathering Facts] ********************************************************************************************************************************
ok: [hw_8_2_lighthouse]

TASK [Installing nginx] *******************************************************************************************************************************
ok: [hw_8_2_lighthouse]

TASK [Copying lighthouse repo] ************************************************************************************************************************
ok: [hw_8_2_lighthouse]

TASK [Adding available site] **************************************************************************************************************************
ok: [hw_8_2_lighthouse]

TASK [Create simlink lighthouse enable] ***************************************************************************************************************
ok: [hw_8_2_lighthouse]

PLAY RECAP ********************************************************************************************************************************************
hw_8_2_clickhouse          : ok=1    changed=0    unreachable=0    failed=1    skipped=0    rescued=0    ignored=0   
hw_8_2_lighthouse          : ok=7    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   
hw_8_2_vector              : ok=7    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   
```

#### 9. Подготовьте README.md-файл по своему playbook. В нём должно быть описано: что делает playbook, какие у него есть параметры и теги.

```
выполнено
```

#### 10. Готовый playbook выложите в свой репозиторий, поставьте тег 08-ansible-03-yandex на фиксирующий коммит, в ответ предоставьте ссылку на него

[Github tag 08-ansible-03-yandex](https://github.com/AlexeyShlagin/devops-netology/releases/tag/08-ansible-03-yandex)
